import asyncio
import time
import math
from typing import Any, Dict, List, Tuple

import bittensor as bt
import numpy as np
import torch

import distributed_training
from distributed_training.averaging.exceptions import AllReduceError, ModelStateError
from distributed_training.protocol import AllReduce


class AveragingHandler:
    """Handles averaging round and outer step for both validators and miners."""

    def __init__(
        self,
        model,
        optimizer,
        grad_averager,
        state_averager,
    ):
        self.model = model
        self.inner_optimizer = optimizer
        self.grad_averager = grad_averager
        self.state_averager = state_averager

    def _get_weights_sample(self) -> List[float]:
        """Get a sample of model weights for validation."""
        return [layer for layer in self.model.parameters()][-2][-10:].tolist()

    def _validate_weight_update(self, initial_weights: List[float]) -> bool:
        """Validate model weight updates."""
        final_weights = self._get_weights_sample()
        bt.logging.info(f"Final Weights Sample: {final_weights}")

        if final_weights == initial_weights:
            raise ModelStateError("Weights unchanged after update")

        if sum(np.isnan(final_weights)) > 1:
            raise ModelStateError("NaN values detected in weights after update")

        if self._test_model_loss:
            raise ModelStateError("NaN values detected in loss generated by new model")

    def _test_model_loss(self) -> bool:
        inputs = torch.tensor(
            [
                [
                    7120,
                    1767,
                    318,
                    534,
                    12505,
                    290,
                    2263,
                    922,
                    1337,
                    286,
                    340,
                    318,
                    23602,
                    611,
                    345,
                    765,
                    284,
                    1085,
                    257,
                    5448,
                    1204,
                    13,
                    198,
                    1026,
                    743,
                    1283,
                    326,
                    1141,
                    11029,
                    534,
                    1767,
                    318,
                    655,
                    9105,
                    21696,
                    13,
                    887,
                    340,
                    318,
                    407,
                    691,
                    9489,
                    20211,
                    475,
                    318,
                    635,
                    2950,
                    287,
                    9482,
                    14653,
                    13,
                    198,
                    9171,
                    28426,
                    1042,
                    318,
                    281,
                    3842,
                    6157,
                    416,
                    262,
                    4778,
                    286,
                    262,
                    1767,
                    284,
                    2270,
                    866,
                    2057,
                    15938,
                    656,
                    1402,
                    10340,
                    13,
                    1649,
                    345,
                    3993,
                    11,
                    257,
                    6903,
                    286,
                    534,
                    3463,
                    2994,
                    1430,
                    318,
                    852,
                    4920,
                    13,
                    1675,
                    651,
                    257,
                    517,
                    2383,
                    3463,
                    2994,
                    981,
                    345,
                    389,
                    11029,
                    11,
                    345,
                    460,
                    2987,
                    534,
                    20211,
                    11,
                    329,
                    1672,
                    11,
                    416,
                    25352,
                    393,
                    6155,
                    329,
                    379,
                    1551,
                    1542,
                    2431,
                    878,
                    1016,
                    284,
                    257,
                    3996,
                    13,
                    198,
                    7085,
                    661,
                    13121,
                    326,
                    484,
                    389,
                    13977,
                    3463,
                    780,
                    286,
                    3105,
                    20211,
                    11,
                    475,
                    845,
                    1178,
                    661,
                    836,
                    447,
                    247,
                    83,
                    6537,
                    326,
                    655,
                    416,
                    1016,
                    329,
                    257,
                    922,
                    1755,
                    447,
                    247,
                    82,
                    3993,
                    345,
                    481,
                    307,
                    1498,
                    284,
                    5529,
                    5448,
                    1767,
                    3463,
                    13,
                    198,
                    25844,
                    21686,
                    290,
                    17376,
                    198,
                    1858,
                    389,
                    867,
                    3640,
                    326,
                    423,
                    587,
                    5952,
                    543,
                    423,
                    3402,
                    326,
                    345,
                    481,
                    4461,
                    3463,
                    611,
                    345,
                    389,
                    407,
                    11029,
                    880,
                    287,
                    2846,
                    286,
                    3081,
                    290,
                    12040,
                    286,
                    3993,
                    13,
                    198,
                    1026,
                    318,
                    1141,
                    262,
                    22657,
                    393,
                    26430,
                    14144,
                    15477,
                    3993,
                    11,
                    326,
                    674,
                    5920,
                    4245,
                    262,
                    5415,
                    286,
                    262,
                    14653,
                    13,
                    770,
                    318,
                    2391,
                    780,
                    262,
                    1692,
                    3632,
                    318,
                    749,
                    4075,
                    1141,
                    326,
                    2278,
                    290,
                    326,
                    318,
                    262,
                    640,
                    618,
                    262,
                    5415,
                    2033,
                    286,
                    15701,
                    318,
                    22999,
                    13,
                    198,
                    2061,
                    318,
                    22657,
                    17376,
                    30,
                    198,
                    1639,
                    4245,
                    517,
                    14653,
                    618,
                    345,
                    389,
                    287,
                    2769,
                    3993,
                    355,
                    3688,
                    284,
                    618,
                    345,
                    389,
                    37432,
                    290,
                    6225,
                    287,
                    3996,
                    393,
                    9105,
                    866,
                    655,
                    981,
                    3555,
                    1223,
                    13,
                    198,
                    2953,
                    262,
                    640,
                    286,
                    11029,
                    534,
                    3632,
                    318,
                    4457,
                    4075,
                    13,
                    554,
                    1109,
                    11,
                    340,
                    318,
                    531,
                    284,
                    307,
                    517,
                    4075,
                    1141,
                    22657,
                    3993,
                    621,
                    867,
                    286,
                    262,
                    1661,
                    618,
                    345,
                    389,
                    3094,
                    21693,
                    13,
                    198,
                    2061,
                    18321,
                    641,
                    1649,
                    921,
                    17376,
                    30,
                    198,
                    47087,
                    1034,
                    500,
                    326,
                    345,
                    3802,
                    262,
                    22657,
                    3993,
                    287,
                    262,
                    1218,
                    2063,
                    286,
                    262,
                    1755,
                    13,
                    632,
                    318,
                    1141,
                    326,
                    640,
                    326,
                    198,
                    7120,
                    14653,
                    447,
                    247,
                    10337,
                    460,
                    307,
                    5676,
                    262,
                    1306,
                    1110,
                    611,
                    345,
                    389,
                    407,
                    1972,
                    281,
                    198,
                    35013,
                    286,
                    17376,
                    198,
                    464,
                    3081,
                    286,
                    3993,
                    326,
                    345,
                    651,
                    318,
                    635,
                    2407,
                    2383,
                    13,
                    2293,
                    477,
                    11,
                    345,
                    651,
                    517,
                    22657,
                    3993,
                    618,
                    345,
                    3993,
                    9211,
                    13,
                    770,
                    835,
                    345,
                    481,
                    4245,
                    881,
                    517,
                    14653,
                    13,
                    198,
                    4864,
                    11,
                    1394,
                    340,
                    287,
                    2000,
                    326,
                    345,
                    1839,
                    447,
                    247,
                    83,
                    307,
                    1498,
                    284,
                    4245,
                    257,
                    5680,
                    286,
                    14653,
                    611,
                    345,
                    3993,
                    477,
                    1110,
                    13,
                    36095,
                    1950,
                    326,
                    883,
                    508,
                    3993,
                    329,
                    1165,
                    890,
                    423,
                    257,
                    881,
                    13611,
                    2494,
                    286,
                    20211,
                    13,
                    770,
                    318,
                    780,
                    484,
                    2652,
                    287,
                    3996,
                    2427,
                    286,
                    262,
                    7118,
                    286,
                    2568,
                    13,
                    198,
                    2437,
                    4650,
                    45133,
                    2141,
                    921,
                    8942,
                    30,
                    198,
                    15056,
                    326,
                    661,
                    10164,
                    287,
                    1180,
                    6867,
                    290,
                    761,
                    1180,
                    6867,
                    286,
                    3993,
                    340,
                    318,
                    407,
                    523,
                    2562,
                    284,
                    1577,
                    257,
                    10017,
                    1271,
                    286,
                    14653,
                    326,
                    262,
                    2811,
                    1048,
                    20246,
                    287,
                    262,
                    3993,
                    13,
                    198,
                    2437,
                    4650,
                    45133,
                    4231,
                    5481,
                    429,
                    1141,
                    17376,
                    30,
                    198,
                    4342,
                    318,
                    257,
                    10451,
                    284,
                    3342,
                    345,
                    8636,
                    703,
                    867,
                    14653,
                    345,
                    4245,
                    981,
                    345,
                    389,
                    16039,
                    13,
                    198,
                    1639,
                    460,
                    15284,
                    534,
                    28740,
                    22895,
                    416,
                    48816,
                    534,
                    3463,
                    351,
                    764,
                    3682,
                    14653,
                    784,
                    262,
                    2811,
                    2033,
                    286,
                    14653,
                    326,
                    389,
                    22999,
                    416,
                    257,
                    1048,
                    329,
                    790,
                    14896,
                    286,
                    511,
                    3463,
                    287,
                    281,
                    1711,
                    286,
                    3993,
                    290,
                    788,
                    48816,
                    262,
                    1255,
                    351,
                    262,
                    1271,
                    286,
                    2250,
                    329,
                    543,
                    345,
                    21256,
                    13,
                    198,
                    1722,
                    281,
                    1672,
                    11,
                    2130,
                    508,
                    24034,
                    6640,
                    8059,
                    290,
                    44263,
                    329,
                    807,
                    2250,
                    561,
                    4245,
                    8093,
                    2386,
                    198,
                    1026,
                    318,
                    2861,
                    10820,
                    11,
                    996,
                    326,
                    428,
                    17952,
                    857,
                    407,
                    2074,
                    326,
                    262,
                    5415,
                    28740,
                    12,
                    44313,
                    8833,
                    1141,
                    262,
                    22657,
                    3800,
                    286,
                    262,
                    3993,
                    355,
                    880,
                    355,
                    262,
                    13870,
                    543,
                    460,
                    2928,
                    534,
                    3993,
                    13,
                    1114,
                    1672,
                    11,
                    6600,
                    1342,
                    379,
                    1755,
                    13,
                    198,
                    43368,
                    284,
                    8942,
                    3125,
                    45133,
                    355,
                    921,
                    17376,
                    198,
                    12,
                    13707,
                    43963,
                    21051,
                    513,
                    19347,
                    878,
                    15585,
                    784,
                    2893,
                    257,
                    3155,
                    286,
                    15232,
                    286,
                    8237,
                    351,
                    262,
                    8073,
                    318,
                    3734,
                    13,
                    921,
                    815,
                    20799,
                    5548,
                    10337,
                    379,
                    1551,
                    513,
                    2250,
                    878,
                    1016,
                    284,
                    3996,
                    13,
                    15323,
                    11,
                    345,
                    1839,
                    447,
                    247,
                    83,
                    307,
                    1498,
                    284,
                    18188,
                    883,
                    9211,
                    9539,
                    286,
                    3993,
                    543,
                    318,
                    6393,
                    329,
                    9482,
                    262,
                    14653,
                    13,
                    198,
                    12,
                    2094,
                    447,
                    247,
                    83,
                    1514,
                    329,
                    13601,
                    2185,
                    874,
                    287,
                    34584,
                    784,
                    921,
                    815,
                    1833,
                    326,
                    6600,
                    2739,
                    857,
                    407,
                    1464,
                    3105,
                    866,
                    262,
                    2494,
                    286,
                    20211,
                    13,
                    921,
                    655,
                    1998,
                    257,
                    3731,
                    28554,
                    287,
                    534,
                    2494,
                    286,
                    20211,
                    543,
                    318,
                    1900,
                    355,
                    21969,
                    25908,
                    13,
                    383,
                    46560,
                    3013,
                    5430,
                    11,
                    2158,
                    11,
                    460,
                    1011,
                    257,
                    13592,
                    319,
                    534,
                    1767,
                    13,
                    887,
                    345,
                    815,
                    3368,
                    262,
                    1588,
                    13840,
                    878,
                    3996,
                    2435,
                    355,
                    484,
                    389,
                    531,
                    284,
                    307,
                    262,
                    4165,
                    26581,
                    82,
                    878,
                    3996,
                    2435,
                    13,
                    198,
                    12,
                    7281,
                    257,
                    17377,
                    17376,
                    23939,
                    784,
                    921,
                    815,
                    467,
                    284,
                    3996,
                    290,
                    7765,
                    510,
                    379,
                    262,
                    976,
                    640,
                    1141,
                    3993,
                    13,
                    770,
                    835,
                    534,
                    1767,
                    481,
                    307,
                    15409,
                    284,
                    5529,
                    257,
                    3218,
                    3993,
                    3912,
                    13,
                    198,
                    12,
                    9175,
                    262,
                    12290,
                    34467,
                    15226,
                    263,
                    784,
                    632,
                    318,
                    531,
                    326,
                    345,
                    481,
                    4245,
                    517,
                    14653,
                    11,
                    287,
                    1109,
                    11,
                    1811,
                    3470,
                    790,
                    1755,
                    611,
                    345,
                    1394,
                    262,
                    1767,
                    5951,
                    1877,
                    13,
                    1649,
                    345,
                    5806,
                    257,
                    6792,
                    290,
                    6546,
                    279,
                    1228,
                    1689,
                    290,
                    18537,
                    510,
                    287,
                    262,
                    5814,
                    34794,
                    11,
                    534,
                    1767,
                    857,
                    407,
                    761,
                    284,
                    4439,
                    262,
                    3131,
                    4894,
                    13,
                    31148,
                    287,
                    262,
                    19346,
                    10101,
                    2845,
                    329,
                    262,
                    34794,
                    290,
                    279,
                    1228,
                    1689,
                    460,
                    787,
                    262,
                    10811,
                    1712,
                    265,
                    286,
                    262,
                    1767,
                    284,
                    2897,
                    3288,
                    4894,
                    13,
                    31148,
                    287,
                    38427,
                    10101,
                    1464,
                    5419,
                    284,
                    4245,
                    510,
                    517,
                    14653,
                    13,
                    198,
                    12,
                    5521,
                    3806,
                    3887,
                    1110,
                    475,
                    1892,
                    878,
                    15585,
                    2435,
                    784,
                    1475,
                    2798,
                    1710,
                    318,
                    257,
                    1049,
                    2126,
                    329,
                    2687,
                    508,
                    318,
                    2111,
                    284,
                    4245,
                    262,
                    14653,
                    1141,
                    262,
                    1110,
                    393,
                    1755,
                    13,
                    887,
                    25352,
                    655,
                    257,
                    3155,
                    286,
                    2250,
                    878,
                    3996,
                    2435,
                    460,
                    2710,
                    510,
                    262,
                    1767,
                    290,
                    428,
                    743,
                    407,
                    1309,
                    345,
                    3993,
                    13,
                    1406,
                    345,
                    815,
                    407,
                    5517,
                    379,
                ]
            ]
        )
        labels = torch.tensor(
            [
                [
                    1767,
                    318,
                    534,
                    12505,
                    290,
                    2263,
                    922,
                    1337,
                    286,
                    340,
                    318,
                    23602,
                    611,
                    345,
                    765,
                    284,
                    1085,
                    257,
                    5448,
                    1204,
                    13,
                    198,
                    1026,
                    743,
                    1283,
                    326,
                    1141,
                    11029,
                    534,
                    1767,
                    318,
                    655,
                    9105,
                    21696,
                    13,
                    887,
                    340,
                    318,
                    407,
                    691,
                    9489,
                    20211,
                    475,
                    318,
                    635,
                    2950,
                    287,
                    9482,
                    14653,
                    13,
                    198,
                    9171,
                    28426,
                    1042,
                    318,
                    281,
                    3842,
                    6157,
                    416,
                    262,
                    4778,
                    286,
                    262,
                    1767,
                    284,
                    2270,
                    866,
                    2057,
                    15938,
                    656,
                    1402,
                    10340,
                    13,
                    1649,
                    345,
                    3993,
                    11,
                    257,
                    6903,
                    286,
                    534,
                    3463,
                    2994,
                    1430,
                    318,
                    852,
                    4920,
                    13,
                    1675,
                    651,
                    257,
                    517,
                    2383,
                    3463,
                    2994,
                    981,
                    345,
                    389,
                    11029,
                    11,
                    345,
                    460,
                    2987,
                    534,
                    20211,
                    11,
                    329,
                    1672,
                    11,
                    416,
                    25352,
                    393,
                    6155,
                    329,
                    379,
                    1551,
                    1542,
                    2431,
                    878,
                    1016,
                    284,
                    257,
                    3996,
                    13,
                    198,
                    7085,
                    661,
                    13121,
                    326,
                    484,
                    389,
                    13977,
                    3463,
                    780,
                    286,
                    3105,
                    20211,
                    11,
                    475,
                    845,
                    1178,
                    661,
                    836,
                    447,
                    247,
                    83,
                    6537,
                    326,
                    655,
                    416,
                    1016,
                    329,
                    257,
                    922,
                    1755,
                    447,
                    247,
                    82,
                    3993,
                    345,
                    481,
                    307,
                    1498,
                    284,
                    5529,
                    5448,
                    1767,
                    3463,
                    13,
                    198,
                    25844,
                    21686,
                    290,
                    17376,
                    198,
                    1858,
                    389,
                    867,
                    3640,
                    326,
                    423,
                    587,
                    5952,
                    543,
                    423,
                    3402,
                    326,
                    345,
                    481,
                    4461,
                    3463,
                    611,
                    345,
                    389,
                    407,
                    11029,
                    880,
                    287,
                    2846,
                    286,
                    3081,
                    290,
                    12040,
                    286,
                    3993,
                    13,
                    198,
                    1026,
                    318,
                    1141,
                    262,
                    22657,
                    393,
                    26430,
                    14144,
                    15477,
                    3993,
                    11,
                    326,
                    674,
                    5920,
                    4245,
                    262,
                    5415,
                    286,
                    262,
                    14653,
                    13,
                    770,
                    318,
                    2391,
                    780,
                    262,
                    1692,
                    3632,
                    318,
                    749,
                    4075,
                    1141,
                    326,
                    2278,
                    290,
                    326,
                    318,
                    262,
                    640,
                    618,
                    262,
                    5415,
                    2033,
                    286,
                    15701,
                    318,
                    22999,
                    13,
                    198,
                    2061,
                    318,
                    22657,
                    17376,
                    30,
                    198,
                    1639,
                    4245,
                    517,
                    14653,
                    618,
                    345,
                    389,
                    287,
                    2769,
                    3993,
                    355,
                    3688,
                    284,
                    618,
                    345,
                    389,
                    37432,
                    290,
                    6225,
                    287,
                    3996,
                    393,
                    9105,
                    866,
                    655,
                    981,
                    3555,
                    1223,
                    13,
                    198,
                    2953,
                    262,
                    640,
                    286,
                    11029,
                    534,
                    3632,
                    318,
                    4457,
                    4075,
                    13,
                    554,
                    1109,
                    11,
                    340,
                    318,
                    531,
                    284,
                    307,
                    517,
                    4075,
                    1141,
                    22657,
                    3993,
                    621,
                    867,
                    286,
                    262,
                    1661,
                    618,
                    345,
                    389,
                    3094,
                    21693,
                    13,
                    198,
                    2061,
                    18321,
                    641,
                    1649,
                    921,
                    17376,
                    30,
                    198,
                    47087,
                    1034,
                    500,
                    326,
                    345,
                    3802,
                    262,
                    22657,
                    3993,
                    287,
                    262,
                    1218,
                    2063,
                    286,
                    262,
                    1755,
                    13,
                    632,
                    318,
                    1141,
                    326,
                    640,
                    326,
                    198,
                    7120,
                    14653,
                    447,
                    247,
                    10337,
                    460,
                    307,
                    5676,
                    262,
                    1306,
                    1110,
                    611,
                    345,
                    389,
                    407,
                    1972,
                    281,
                    198,
                    35013,
                    286,
                    17376,
                    198,
                    464,
                    3081,
                    286,
                    3993,
                    326,
                    345,
                    651,
                    318,
                    635,
                    2407,
                    2383,
                    13,
                    2293,
                    477,
                    11,
                    345,
                    651,
                    517,
                    22657,
                    3993,
                    618,
                    345,
                    3993,
                    9211,
                    13,
                    770,
                    835,
                    345,
                    481,
                    4245,
                    881,
                    517,
                    14653,
                    13,
                    198,
                    4864,
                    11,
                    1394,
                    340,
                    287,
                    2000,
                    326,
                    345,
                    1839,
                    447,
                    247,
                    83,
                    307,
                    1498,
                    284,
                    4245,
                    257,
                    5680,
                    286,
                    14653,
                    611,
                    345,
                    3993,
                    477,
                    1110,
                    13,
                    36095,
                    1950,
                    326,
                    883,
                    508,
                    3993,
                    329,
                    1165,
                    890,
                    423,
                    257,
                    881,
                    13611,
                    2494,
                    286,
                    20211,
                    13,
                    770,
                    318,
                    780,
                    484,
                    2652,
                    287,
                    3996,
                    2427,
                    286,
                    262,
                    7118,
                    286,
                    2568,
                    13,
                    198,
                    2437,
                    4650,
                    45133,
                    2141,
                    921,
                    8942,
                    30,
                    198,
                    15056,
                    326,
                    661,
                    10164,
                    287,
                    1180,
                    6867,
                    290,
                    761,
                    1180,
                    6867,
                    286,
                    3993,
                    340,
                    318,
                    407,
                    523,
                    2562,
                    284,
                    1577,
                    257,
                    10017,
                    1271,
                    286,
                    14653,
                    326,
                    262,
                    2811,
                    1048,
                    20246,
                    287,
                    262,
                    3993,
                    13,
                    198,
                    2437,
                    4650,
                    45133,
                    4231,
                    5481,
                    429,
                    1141,
                    17376,
                    30,
                    198,
                    4342,
                    318,
                    257,
                    10451,
                    284,
                    3342,
                    345,
                    8636,
                    703,
                    867,
                    14653,
                    345,
                    4245,
                    981,
                    345,
                    389,
                    16039,
                    13,
                    198,
                    1639,
                    460,
                    15284,
                    534,
                    28740,
                    22895,
                    416,
                    48816,
                    534,
                    3463,
                    351,
                    764,
                    3682,
                    14653,
                    784,
                    262,
                    2811,
                    2033,
                    286,
                    14653,
                    326,
                    389,
                    22999,
                    416,
                    257,
                    1048,
                    329,
                    790,
                    14896,
                    286,
                    511,
                    3463,
                    287,
                    281,
                    1711,
                    286,
                    3993,
                    290,
                    788,
                    48816,
                    262,
                    1255,
                    351,
                    262,
                    1271,
                    286,
                    2250,
                    329,
                    543,
                    345,
                    21256,
                    13,
                    198,
                    1722,
                    281,
                    1672,
                    11,
                    2130,
                    508,
                    24034,
                    6640,
                    8059,
                    290,
                    44263,
                    329,
                    807,
                    2250,
                    561,
                    4245,
                    8093,
                    2386,
                    198,
                    1026,
                    318,
                    2861,
                    10820,
                    11,
                    996,
                    326,
                    428,
                    17952,
                    857,
                    407,
                    2074,
                    326,
                    262,
                    5415,
                    28740,
                    12,
                    44313,
                    8833,
                    1141,
                    262,
                    22657,
                    3800,
                    286,
                    262,
                    3993,
                    355,
                    880,
                    355,
                    262,
                    13870,
                    543,
                    460,
                    2928,
                    534,
                    3993,
                    13,
                    1114,
                    1672,
                    11,
                    6600,
                    1342,
                    379,
                    1755,
                    13,
                    198,
                    43368,
                    284,
                    8942,
                    3125,
                    45133,
                    355,
                    921,
                    17376,
                    198,
                    12,
                    13707,
                    43963,
                    21051,
                    513,
                    19347,
                    878,
                    15585,
                    784,
                    2893,
                    257,
                    3155,
                    286,
                    15232,
                    286,
                    8237,
                    351,
                    262,
                    8073,
                    318,
                    3734,
                    13,
                    921,
                    815,
                    20799,
                    5548,
                    10337,
                    379,
                    1551,
                    513,
                    2250,
                    878,
                    1016,
                    284,
                    3996,
                    13,
                    15323,
                    11,
                    345,
                    1839,
                    447,
                    247,
                    83,
                    307,
                    1498,
                    284,
                    18188,
                    883,
                    9211,
                    9539,
                    286,
                    3993,
                    543,
                    318,
                    6393,
                    329,
                    9482,
                    262,
                    14653,
                    13,
                    198,
                    12,
                    2094,
                    447,
                    247,
                    83,
                    1514,
                    329,
                    13601,
                    2185,
                    874,
                    287,
                    34584,
                    784,
                    921,
                    815,
                    1833,
                    326,
                    6600,
                    2739,
                    857,
                    407,
                    1464,
                    3105,
                    866,
                    262,
                    2494,
                    286,
                    20211,
                    13,
                    921,
                    655,
                    1998,
                    257,
                    3731,
                    28554,
                    287,
                    534,
                    2494,
                    286,
                    20211,
                    543,
                    318,
                    1900,
                    355,
                    21969,
                    25908,
                    13,
                    383,
                    46560,
                    3013,
                    5430,
                    11,
                    2158,
                    11,
                    460,
                    1011,
                    257,
                    13592,
                    319,
                    534,
                    1767,
                    13,
                    887,
                    345,
                    815,
                    3368,
                    262,
                    1588,
                    13840,
                    878,
                    3996,
                    2435,
                    355,
                    484,
                    389,
                    531,
                    284,
                    307,
                    262,
                    4165,
                    26581,
                    82,
                    878,
                    3996,
                    2435,
                    13,
                    198,
                    12,
                    7281,
                    257,
                    17377,
                    17376,
                    23939,
                    784,
                    921,
                    815,
                    467,
                    284,
                    3996,
                    290,
                    7765,
                    510,
                    379,
                    262,
                    976,
                    640,
                    1141,
                    3993,
                    13,
                    770,
                    835,
                    534,
                    1767,
                    481,
                    307,
                    15409,
                    284,
                    5529,
                    257,
                    3218,
                    3993,
                    3912,
                    13,
                    198,
                    12,
                    9175,
                    262,
                    12290,
                    34467,
                    15226,
                    263,
                    784,
                    632,
                    318,
                    531,
                    326,
                    345,
                    481,
                    4245,
                    517,
                    14653,
                    11,
                    287,
                    1109,
                    11,
                    1811,
                    3470,
                    790,
                    1755,
                    611,
                    345,
                    1394,
                    262,
                    1767,
                    5951,
                    1877,
                    13,
                    1649,
                    345,
                    5806,
                    257,
                    6792,
                    290,
                    6546,
                    279,
                    1228,
                    1689,
                    290,
                    18537,
                    510,
                    287,
                    262,
                    5814,
                    34794,
                    11,
                    534,
                    1767,
                    857,
                    407,
                    761,
                    284,
                    4439,
                    262,
                    3131,
                    4894,
                    13,
                    31148,
                    287,
                    262,
                    19346,
                    10101,
                    2845,
                    329,
                    262,
                    34794,
                    290,
                    279,
                    1228,
                    1689,
                    460,
                    787,
                    262,
                    10811,
                    1712,
                    265,
                    286,
                    262,
                    1767,
                    284,
                    2897,
                    3288,
                    4894,
                    13,
                    31148,
                    287,
                    38427,
                    10101,
                    1464,
                    5419,
                    284,
                    4245,
                    510,
                    517,
                    14653,
                    13,
                    198,
                    12,
                    5521,
                    3806,
                    3887,
                    1110,
                    475,
                    1892,
                    878,
                    15585,
                    2435,
                    784,
                    1475,
                    2798,
                    1710,
                    318,
                    257,
                    1049,
                    2126,
                    329,
                    2687,
                    508,
                    318,
                    2111,
                    284,
                    4245,
                    262,
                    14653,
                    1141,
                    262,
                    1110,
                    393,
                    1755,
                    13,
                    887,
                    25352,
                    655,
                    257,
                    3155,
                    286,
                    2250,
                    878,
                    3996,
                    2435,
                    460,
                    2710,
                    510,
                    262,
                    1767,
                    290,
                    428,
                    743,
                    407,
                    1309,
                    345,
                    3993,
                    13,
                    1406,
                    345,
                    815,
                    407,
                    5517,
                    379,
                    50256,
                ]
            ]
        )
        inputs, labels = inputs.to(self.device), labels.to(self.device)
        with torch.autocast(device_type="cuda", dtype=torch.bfloat16):
            outputs = self.model(input_ids=inputs, labels=labels)
            loss = outputs[1] / self.number_of_local_steps

        return math.isnan(loss.item())

    async def run_validator_allreduce(
        self,
        timeout: int,
        dendrite_pool,
        peerids_to_uids,
        miner_uids,
        master,
        bandwidth=None,
    ) -> Tuple[bool, Dict[str, Any]]:
        """
        Process allreduce specifically for validator.

        Returns:
            Tuple[bool, Dict[str, Any]]: (success, results)
            - success: True if allreduce completed successfully, False otherwise
            - results: Dictionary containing peers and bandwidth info if successful, empty dict if failed
        """
        query_tasks = []
        all_reduce_success_status = True
        results = {}

        try:
            # Clip gradients
            torch.nn.utils.clip_grad_norm_(self.model.parameters(), 1.0)

            # Used for load balancing and scoring
            if bandwidth is not None:
                self.grad_averager.bandwidth = bandwidth["download"]

            bt.logging.info(":wait: Starting Pseudo Gradient Averaging..")
            # Start gradient averaging without waiting
            gradient_averaging_step = self.grad_averager.step(
                timeout=timeout,
                wait=False,
                gather=0,
                peerids_to_uids=peerids_to_uids,
            )

            if master:
                # Send AllReduce query to pause miner training and perform global sync
                query_tasks.append(
                    dendrite_pool.async_forward(
                        miner_uids,
                        [AllReduce(completion=False) for _ in miner_uids],
                        timeout=timeout,
                    )
                )
                bt.logging.info(
                    ":wait: AllReduce Query Sent Out. Waiting for AllReduce to finish.."
                )
                await asyncio.gather(*query_tasks)
                bt.logging.info("AllReduce Query Responses Received..")

            start_time = time.perf_counter()

            while (gradient_averaging_step.done() is False) and (
                (time.perf_counter() - start_time) <= (timeout)
            ):
                await asyncio.sleep(1)

            if gradient_averaging_step.done():
                bt.logging.info(
                    ":white_heavy_check_mark: Finished Averaging Pseudo Gradients"
                )
                self.grad_averager.notify_used_averaged_gradients()

                (
                    gathered,
                    failed_peers,
                    participating_peers,
                    modes,
                    bandwidths,
                ) = gradient_averaging_step.result()

                initial_weights = self._get_weights_sample()
                bt.logging.info(f"Initial Weights Sample: {initial_weights}")

                # Perform offloaded outer optimization steps
                bt.logging.info("Performing Outer Optimizer Step..")
                self.state_averager.step(
                    increment_epoch=True, optimizer_step=True, zero_grad=False
                )

                # Update state_avgs main params with inner optimizer params
                self.update_main_param_after_outer_step()

                bt.logging.info(
                    ":white_heavy_check_mark: Finished Outer Optimizer Step."
                )

                # Validate weight updates
                self._validate_weight_update(initial_weights)

                all_reduce_success_status = True
                results = {
                    "gathered": gathered,
                    "failed_peers": failed_peers,
                    "participating_peers": participating_peers,
                    "modes": modes,
                    "bandwidths": bandwidths,
                }
            else:
                all_reduce_success_status = False

        except Exception as e:
            bt.logging.error(f"Unexpected error during Averaging Process: {str(e)}")
            all_reduce_success_status = False

        finally:
            if gradient_averaging_step:
                gradient_averaging_step.cancel()
                bt.logging.info("Gradient Step Cleaned Up")
            if all_reduce_success_status:
                bt.logging.success("Averaging Round Finished Succesfully")
            return all_reduce_success_status, results

    def calculate_allreduce_scores(
        self,
        participating_peers: list,
        failed_peers: list,
        peerids_to_uids: dict,
        event: dict,
        metagraph,
        modes: list = None,
        bandwidths: list = None,
    ) -> dict:
        """
        Calculate scores based on AllReduce participation status, modes, and bandwidths.

        Args:
            participating_peers (list): List of peers that participated in AllReduce
            failed_peers (list): List of peers that failed during AllReduce
            peerids_to_uids (dict): Mapping of peer IDs to UIDs
            modes (list, optional): List of modes for each participating peer
            bandwidths (list, optional): List of bandwidths for each participating peer

        Returns:
            dict: Scores for each UID based on participation and optional mode/bandwidth
        """
        # Convert peer IDs to UIDs
        participating_uids = []
        uid_modes = {}
        uid_bandwidths = {}

        for idx, peer in enumerate(participating_peers):
            uid = peerids_to_uids.get(str(peer), "'''")
            participating_uids.append(uid)
            if modes is not None:
                uid_modes[uid] = modes[idx]
            if bandwidths is not None:
                uid_bandwidths[uid] = bandwidths[idx]

        failed_uids = [
            peerids_to_uids.get(str(failed_peer), "'''") for failed_peer in failed_peers
        ]

        # Calculate participation metrics
        successful_peers_count = len(participating_peers) - len(failed_peers)

        # Update event metrics
        event.update(
            {
                "failed_peers_count": len(failed_peers),
                "participating_peers_count": len(participating_peers),
                "successful_peers_count": successful_peers_count,
            }
        )

        # Find max bandwidth for normalization if bandwidths are provided
        if (
            bandwidths
            and [bandwidth for bandwidth in bandwidths if bandwidth is not None] != []
            and max([bandwidth for bandwidth in bandwidths if bandwidth is not None])
            != []
        ):
            max_bandwidth = max(
                [bandwidth for bandwidth in bandwidths if bandwidth is not None]
            )

        # Initialize scores dictionary
        scores = {}
        status_dict = {}
        for uid in range(metagraph.n):  # Assuming 256 UIDs in metagraph
            str_uid = str(uid)
            if uid in participating_uids and uid not in failed_uids:
                # Base score for successful participation
                base_score = 1.0
                final_score = base_score
                status = "SUCCESS"

                # Apply mode penalty if modes are provided
                if modes is not None and uid in uid_modes:
                    if uid_modes[uid] == "AveragingMode.CLIENT":
                        final_score = 0.0
                        status = "WRONG_MODE"

                # Apply bandwidth bonus if bandwidths are provided
                if (
                    bandwidths is not None
                    and uid in uid_bandwidths
                    and status != "WRONG_MODE"
                ):
                    if uid_bandwidths[uid] is None:
                        final_score = 0.0
                    else:
                        bandwidth_bonus = 0.5 * (uid_bandwidths[uid] / max_bandwidth)
                        final_score += bandwidth_bonus
                        bt.logging.info(
                            f"UID {uid} score breakdown - Base: {base_score:.2f}, Bandwidth bonus: {bandwidth_bonus:.2f}"
                        )

                scores[str_uid] = 1.0
                status_dict[str_uid] = status

            elif uid in failed_uids:
                scores[str_uid] = 0.0
                status_dict[str_uid] = "FAIL"
            else:
                scores[str_uid] = 0.0
                status_dict[str_uid] = "NON_PARTICIPATING"

        # Create rewards tensor
        rewards = torch.tensor([reward for reward in scores.values()])

        # Log participation and scoring details
        bt.logging.info(f"Failed UIDs: {failed_uids}")
        bt.logging.info(f"Participating UIDs: {participating_uids}")
        if modes is not None:
            bt.logging.info(f"Modes by UID: {uid_modes}")
        if bandwidths is not None:
            bt.logging.info(f"Bandwidths by UID: {uid_bandwidths}")
        bt.logging.info(f"AllReduce UID Scores: {scores}")
        bt.logging.info(f"AllReduce UID Rewards: {rewards}")

        return rewards, status_dict, event

    async def run_miner_allreduce(
        self,
        synapse,
        local_progress,
        start_time,
        bandwidth=None,
    ) -> distributed_training.protocol.AllReduce:
        """Process allreduce specifically for miner."""
        try:
            # Clip gradients
            torch.nn.utils.clip_grad_norm_(self.model.parameters(), 1.0)

            # Used for load balancing and scoring
            if bandwidth is not None:
                self.grad_averager.bandwidth = bandwidth["download"]

            bt.logging.info(":wait: Starting Pseudo Gradient Averaging..")
            gradient_averaging_step = self.grad_averager.step(
                timeout=(synapse.timeout - 20),
                wait=False,
                gather=local_progress.samples_accumulated,
            )

            while (gradient_averaging_step.done() is False) and (
                (time.perf_counter() - start_time) <= (synapse.timeout - 20)
            ):
                await asyncio.sleep(1)

            if gradient_averaging_step.done():
                bt.logging.info(
                    ":white_heavy_check_mark: Finished Averaging Pseudo Gradients"
                )
                self.grad_averager.notify_used_averaged_gradients()

                initial_weights = self._get_weights_sample()
                bt.logging.info(f"Initial Weights Sample: {initial_weights}")

                # Perform offloaded outer optimization steps
                bt.logging.info("Performing Outer Optimizer Step")
                self.state_averager.step(
                    increment_epoch=True, optimizer_step=True, zero_grad=False
                )
                self.update_main_param_after_outer_step()

                bt.logging.info(
                    ":white_heavy_check_mark: Finished Outer Optimizer Step."
                )

                # Validate weight updates
                self._validate_weight_update(initial_weights)
                synapse.completion = True
            else:
                synapse.completion = False

        except Exception as e:
            bt.logging.error(f"Unexpected error during Averaging Process: {str(e)}")
            synapse.completion = False
            raise AllReduceError(
                f"Unexpected error during Averaging Process: {str(e)}"
            ) from e

        finally:
            if gradient_averaging_step:
                gradient_averaging_step.cancel()
                bt.logging.info("Gradient Step Cleaned Up")
            if synapse.completion:
                bt.logging.success("Averaging Round Finished Succesfully")
            return synapse

    def update_main_param_after_outer_step(self):
        """Update the main parameters with the inner optimizer step"""
        opt_parameters = [
            param
            for group in self.inner_optimizer.param_groups
            for param in group["params"]
        ]
        for main_param, opt_param in zip(
            self.state_averager.main_parameters, opt_parameters
        ):
            main_param.data.copy_(opt_param.data, non_blocking=True)
